(function(k,u){function q(a,h){var f=k.extend({keydown:null,keyup:null,keypress:null,change:null,highlights:null},h),c=k('<div data-type="richtextbox"></div>');c.attr("style",a.attr("style")).addClass(a.attr("class"));c.attr("contenteditable","true");c.insertBefore(a);null!=f.keydown&&c.keydown(function(b){13==b.keyCode&&b.preventDefault();f.keydown(c,a,b)});null!=f.keyup&&c.keyup(function(b){13==b.keyCode&&b.preventDefault();f.keyup(c,a,b)});null!=f.keypress&&c.keypress(function(b){13==b.keyCode&&
b.preventDefault();f.keypress(c,a,b)});c.bind("blur keyup paste copy cut mouseup",function(){var b,l,h=c.text(),d="<span>",g="",e,n=!0,m="",s=r(c[0]);for(b=0;b<h.length;b++){e=h.charAt(b);if(!/[a-zA-Z0-9_]/.test(e)){n&&(n=!1,d+="</span>");""!=m&&(g+="</"+m+">",m="");for(l=0;l<f.highlights.length;l++){var p=k.extend({key:null,style:null,markup:null,editable:!0,onDataFeeds:null,itemDecorator:null},f.highlights[l]);if(e==p.key){n=!0;d+='<span data-highlight="'+e+'"'+(null==p.style?"":' class="'+p.style+
'"')+">";null!=p.markup&&(m=p.markup,g+="<"+m+">");break}}n||(d+="<span>",n=!0)}d+=e;g+=e}n&&(d+="</span>");""!=m&&(g+="</"+m+">");c.html(d);t(c[0],s);b=g;a.val()!=b&&(a.val(b),null!=f.change&&f.change(c,a))});a.css("display","none");return c}function r(a){function h(e,a){if(3==e.nodeType){l||e!=a.startContainer||(c=f+a.startOffset,l=!0);if(l&&e==a.endContainer)throw b=f+a.endOffset,k;f+=e.length}else for(var g=0,d=e.childNodes.length;g<d;++g)h(e.childNodes[g],a)}var f=0,c=0,b=0,l=!1,k={},d=rangy.getSelection();
if(d.rangeCount)try{h(a,d.getRangeAt(0))}catch(g){if(g!=k)throw g;}return{start:c,end:b}}function t(a,h){function f(a){if(3==a.nodeType){var e=c+a.length;!l&&h.start>=c&&h.start<=e&&(b.setStart(a,h.start-c),l=!0);if(l&&h.end>=c&&h.end<=e)throw b.setEnd(a,h.end-c),k;c=e}else for(var e=0,d=a.childNodes.length;e<d;++e)f(a.childNodes[e])}var c=0,b=rangy.createRange(),l=!1,k={};b.collapseToPoint(a,0);try{f(a)}catch(d){if(d==k)rangy.getSelection().setSingleRange(b);else throw d;}}k.fn.richtextbox=function(a){0==
k("style[data-type=richtextbox]").length&&k("head").append('<style data-type="richtextbox">div[data-type=richtextbox] { white-space:nowrap; overflow:hidden; } div[data-type=richtextbox] br{display:none;} div[data-type=richtextbox] *{display:inline;white-space:nowrap;}</style>');return q(this,a)};k.fn.setReadonly=function(a){a?this.attr("contenteditable","false"):this.attr("contenteditable","true")}})(jQuery,window);